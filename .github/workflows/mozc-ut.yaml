name: Build

on: [push]

permissions: read-all

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true
jobs:
  build_windows:
    runs-on: windows-latest
    timeout-minutes: 120

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        repository: google/mozc
        submodules: 'recursive'

    - name: Checkout
      uses: actions/checkout@v4
      with:
        repository: stm7128/merge-ut-dictionaries-win
        path: merge-ut-dictionaries-win

    - name: Set up Ruby
      uses: actions/setup-ruby@v1
      with:
        ruby-version: 2.7
    
    - name: make UT dic
      shell: cmd
      working-directory: .\merge-ut-dictionaries-win\src\
      run: |
        .\make.ps1
        Get-Content .\mozcdic-ut.txt >> ..\src\data\dictionary_oss\dictionary00.txt
        
    - name: Set up pip
      shell: cmd
      working-directory: .\src
      run: |
        ls ..\artifacts
        python -m pip install six requests
    - name: Download artifact
      uses: actions/download-artifact@v4
      with:
        name: mozcdic-ut
        
    - name: Check
      shell: cmd
      run: |
        ls
        
    - name: copy UT dic
      shell: powershell
      run: |
        Get-Content .\mozcdic-ut-windows.txt >> .\src\data\dictionary_oss\dictionary00.txt


    - name: Try to restore update_deps cache
      uses: actions/cache@v4
      with:
        path: src/third_party_cache
        key: update_deps-${{ runner.os }}-${{ hashFiles('src/build_tools/update_deps.py') }}

    - name: Install Dependencies
      shell: cmd
      working-directory: .\src
      # This command uses src/third_party_cache as the download cache.
      run: |
        python build_tools/update_deps.py


    - name: Biuld Qt
      shell: cmd
      working-directory: .\src
      run: |
        python build_tools/build_qt.py --release --confirm_license

    - name: Delete Qt src to save disk space
      shell: cmd
      working-directory: .\src
      run: |
        rmdir third_party\qt_src /s /q

    - name: gyp
      shell: cmd
      working-directory: .\src
      run: |
        python build_mozc.py gyp

    - name: build package
      shell: cmd
      working-directory: .\src
      run: |
        python build_mozc.py build -c Release package


    - name: upload Mozc64.msi
      uses: actions/upload-artifact@v4
      with:
        name: Mozc64.msi
        path: src/out_win/Release/Mozc64.msi
        if-no-files-found: warn



  cache_deps:
  # https://github.com/actions/runner-images/blob/main/images/windows/Windows2022-Readme.md
    runs-on: windows-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: google/mozc
          submodules: 'recursive'

      - name: Set up pip
        shell: cmd
        working-directory: .\src
        run: |
          python -m pip install requests

      - name: Try to restore update_deps cache
        uses: actions/cache@v4
        with:
          path: src/third_party_cache
          key: update_deps-${{ runner.os }}-${{ hashFiles('src/build_tools/update_deps.py') }}

      - name: Install Dependencies
        shell: cmd
        working-directory: .\src
        # This command uses src/third_party_cache as the download cache.
        run: |
          python build_tools/update_deps.py --cache_only